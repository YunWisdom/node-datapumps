<!DOCTYPE html>

<html>
<head>
  <title>BufferDebugMixin.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="BatchMixin.html">
                BatchMixin.coffee
              </a>
            
              
              <a class="source" href="BufferDebugMixin.html">
                BufferDebugMixin.coffee
              </a>
            
              
              <a class="source" href="CsvWriterMixin.html">
                CsvWriterMixin.coffee
              </a>
            
              
              <a class="source" href="ExcelReaderMixin.html">
                ExcelReaderMixin.coffee
              </a>
            
              
              <a class="source" href="ExcelWriterMixin.html">
                ExcelWriterMixin.coffee
              </a>
            
              
              <a class="source" href="MergeMixin.html">
                MergeMixin.coffee
              </a>
            
              
              <a class="source" href="MongodbMixin.html">
                MongodbMixin.coffee
              </a>
            
              
              <a class="source" href="MysqlMixin.html">
                MysqlMixin.coffee
              </a>
            
              
              <a class="source" href="ObjectTransformMixin.html">
                ObjectTransformMixin.coffee
              </a>
            
              
              <a class="source" href="PostgresqlMixin.html">
                PostgresqlMixin.coffee
              </a>
            
              
              <a class="source" href="RestMixin.html">
                RestMixin.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>BufferDebugMixin.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-built_in">module</span>.<span class="hljs-function"><span class="hljs-title">exports</span> = <span class="hljs-params">(pump)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> <span class="hljs-string">'_bufferDebugMixin'</span> <span class="hljs-keyword">of</span> pump

  _start = pump.start
  _bufferStats = {}

  pump._bufferDebugMixin =
    <span class="hljs-attribute">version</span>: <span class="hljs-number">1</span>

  pump.<span class="hljs-function"><span class="hljs-title">start</span> = -&gt;</span>
    _start.call pump
    <span class="hljs-keyword">return</span> @ <span class="hljs-keyword">if</span> <span class="hljs-property">@_debug</span> != <span class="hljs-literal">true</span>

    collectBuffers()
    listenToBuffersEvents()
    monitorBuffers()
    pump.whenFinished()
      .<span class="hljs-keyword">then</span><span class="hljs-function"> -&gt;</span> dumpStats()
    @

  <span class="hljs-function"><span class="hljs-title">collectBuffers</span> = -&gt;</span>
    _bufferStats = { <span class="hljs-attribute">input</span>: { <span class="hljs-attribute">buffer</span>: pump.from() } }
    _bufferStats[name] = { <span class="hljs-attribute">buffer</span>: buffer } <span class="hljs-keyword">for</span> name, buffer <span class="hljs-keyword">of</span> pump.buffers()
    clearBufferStats()

  <span class="hljs-function"><span class="hljs-title">clearBufferStats</span> = -&gt;</span>
    <span class="hljs-keyword">for</span> name, buffer <span class="hljs-keyword">of</span> _bufferStats
      buffer.releases = <span class="hljs-number">0</span>
      buffer.writes = <span class="hljs-number">0</span>

  <span class="hljs-function"><span class="hljs-title">listenToBuffersEvents</span> = -&gt;</span>
    <span class="hljs-keyword">for</span> name, buffer <span class="hljs-keyword">of</span> _bufferStats
      <span class="hljs-keyword">do</span> <span class="hljs-function"><span class="hljs-params">(buffer)</span> -&gt;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> !buffer.buffer
        buffer.buffer.<span class="hljs-literal">on</span> <span class="hljs-string">'write'</span>,<span class="hljs-function"> -&gt;</span> buffer.writes++
        buffer.buffer.<span class="hljs-literal">on</span> <span class="hljs-string">'release'</span>,<span class="hljs-function"> -&gt;</span> buffer.releases++

  <span class="hljs-function"><span class="hljs-title">monitorBuffers</span> = -&gt;</span>
    delay <span class="hljs-number">1000</span>,<span class="hljs-function"> -&gt;</span>
      dumpStatsIfNotEnded()
      clearBufferStats()
      monitorBuffers() <span class="hljs-keyword">if</span> !pump.isEnded()

  <span class="hljs-function"><span class="hljs-title">delay</span> = <span class="hljs-params">(ms, func)</span> -&gt;</span> setTimeout func, ms

  <span class="hljs-function"><span class="hljs-title">dumpStatsIfNotEnded</span> = -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> pump.isEnded()
    dumpStats()

  <span class="hljs-function"><span class="hljs-title">dumpStats</span> = -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> !hadTraffic()

    process.stdout.write <span class="hljs-string">"<span class="hljs-subst">#{(<span class="hljs-keyword">new</span> Date()).toISOString() }</span> [<span class="hljs-subst">#{pump.id() ? <span class="hljs-string">'(root)'</span>}</span>] "</span>
    <span class="hljs-keyword">for</span> name, buffer <span class="hljs-keyword">of</span> _bufferStats
      process.stdout.write <span class="hljs-string">"<span class="hljs-subst">#{name}</span>: <span class="hljs-subst">#{buffer.buffer.getContent().length}</span> items, <span class="hljs-subst">#{buffer.writes}</span> in, <span class="hljs-subst">#{buffer.releases}</span> out | "</span>
    process.stdout.write <span class="hljs-string">"\n"</span>

  <span class="hljs-function"><span class="hljs-title">hadTraffic</span> =  -&gt;</span>
    <span class="hljs-keyword">for</span> name, buffer <span class="hljs-keyword">of</span> _bufferStats
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">if</span> buffer.releases &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> buffer.writes &gt; <span class="hljs-number">0</span>
    <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
