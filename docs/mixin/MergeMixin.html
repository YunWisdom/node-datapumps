<!DOCTYPE html>

<html>
<head>
  <title>MergeMixin.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="BatchMixin.html">
                BatchMixin.coffee
              </a>
            
              
              <a class="source" href="BufferDebugMixin.html">
                BufferDebugMixin.coffee
              </a>
            
              
              <a class="source" href="CsvWriterMixin.html">
                CsvWriterMixin.coffee
              </a>
            
              
              <a class="source" href="ExcelReaderMixin.html">
                ExcelReaderMixin.coffee
              </a>
            
              
              <a class="source" href="ExcelWriterMixin.html">
                ExcelWriterMixin.coffee
              </a>
            
              
              <a class="source" href="MergeMixin.html">
                MergeMixin.coffee
              </a>
            
              
              <a class="source" href="MongodbMixin.html">
                MongodbMixin.coffee
              </a>
            
              
              <a class="source" href="MysqlMixin.html">
                MysqlMixin.coffee
              </a>
            
              
              <a class="source" href="ObjectTransformMixin.html">
                ObjectTransformMixin.coffee
              </a>
            
              
              <a class="source" href="PostgresqlMixin.html">
                PostgresqlMixin.coffee
              </a>
            
              
              <a class="source" href="RestMixin.html">
                RestMixin.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>MergeMixin.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Mixin to enable pump to read from multiple input buffers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Pump = <span class="hljs-built_in">require</span> <span class="hljs-string">'../Pump'</span>
Buffer = <span class="hljs-built_in">require</span> <span class="hljs-string">'../Buffer'</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MergeHelperPump</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Pump</span></span>
  <span class="hljs-attribute">sealOutputBuffers</span>:<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@emit</span> <span class="hljs-string">'sealOutput'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Normally, <code>.from()</code> sets the input buffer or stream of the pump. When <code>MergeMixin</code> is added,
<code>.from()</code> can be called multiple times and pump will read from all given buffers.</p>
<p>Usage:</p>
<pre><code class="lang-coffee">{ MergeMixin } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'datapumps/mixins'</span>)
pump
  .mixin MergeMixin
  .from buffer1
  .from buffer2
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-title">MergeMixin</span> = <span class="hljs-params">(pump)</span> -&gt;</span>
  pump.from <span class="hljs-keyword">new</span> Buffer()
  pump._fromBuffers = []

  pump.<span class="hljs-function"><span class="hljs-title">from</span> = <span class="hljs-params">(buffer = <span class="hljs-literal">null</span>)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-property">@_from</span> <span class="hljs-keyword">if</span> buffer == <span class="hljs-literal">null</span>

    <span class="hljs-keyword">if</span> <span class="hljs-property">@_state</span> == Pump.STARTED
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">'Cannot change source buffer after pumping has been started'</span>
    <span class="hljs-keyword">if</span> buffer <span class="hljs-keyword">instanceof</span> Buffer
      sourceBuffer = buffer
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> buffer <span class="hljs-keyword">instanceof</span> Pump
      sourceBuffer = buffer.buffer()
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> buffer <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>)
      sourceBuffer = <span class="hljs-keyword">new</span> Buffer
        <span class="hljs-attribute">size</span>: <span class="hljs-number">1000</span>
      buffer.<span class="hljs-literal">on</span> <span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-params">(data)</span> =&gt;</span> sourceBuffer.write data
      buffer.<span class="hljs-literal">on</span> <span class="hljs-string">'end'</span>,<span class="hljs-function"> =&gt;</span> sourceBuffer.seal()
      buffer.<span class="hljs-literal">on</span> <span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span> <span class="hljs-property">@writeError</span> err
      sourceBuffer.<span class="hljs-literal">on</span> <span class="hljs-string">'full'</span>,<span class="hljs-function"> -&gt;</span> buffer.pause()
      sourceBuffer.<span class="hljs-literal">on</span> <span class="hljs-string">'release'</span>,<span class="hljs-function"> -&gt;</span> buffer.resume()
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">'Argument must be datapumps.Buffer or stream'</span>

    <span class="hljs-property">@_fromBuffers</span>.push sourceBuffer

    (helperPump = <span class="hljs-keyword">new</span> MergeHelperPump())
      .from sourceBuffer
      .buffer <span class="hljs-string">'output'</span>, <span class="hljs-property">@_from</span>
      .process <span class="hljs-function"><span class="hljs-params">(data)</span> -&gt;</span>
        <span class="hljs-property">@copy</span> data

    helperPump
      .<span class="hljs-literal">on</span> <span class="hljs-string">'sealOutput'</span>,<span class="hljs-function"> -&gt;</span>
        allEnded = <span class="hljs-literal">true</span>
        <span class="hljs-keyword">for</span> buffer <span class="hljs-keyword">in</span> pump._fromBuffers
          allEnded = <span class="hljs-literal">false</span> <span class="hljs-keyword">if</span> !buffer.isEnded()
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> !allEnded

        pump._from.seal() <span class="hljs-keyword">if</span> !pump._from.isSealed()
      .start()

    @</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
